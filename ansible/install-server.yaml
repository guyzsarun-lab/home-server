---
- name: Install Server
  hosts: ubuntu-server
  gather_facts: true
  become: true
  vars:
    HARBOR_VERSION: v2.8.2
    VAULT_KEY_SHARE: 5
    VAULT_KEY_THRES: 3
    ZEROTIER_NETWORK_ID:

  tasks:
  - name: Install essentials
    apt:
      name:
        - docker
        - net-tools
        - gpg
        - docker-compose
        - prometheus-node-exporter
      state: present
      update_cache: yes
    tags:
    - always

  - name: Install, Config Zerotier
    tags: zerotier
    block:
      - shell: |
          curl -s https://install.zerotier.com | sudo bash

      - name: Start Zerotier
        systemd:
          name: zerotier-one
          state: restarted
          enabled: true
          daemon_reload: true

      - name: Join Network
        shell: |
          zerotier-cli join {{ ZEROTIER_NETWORK_ID }}


  - name: Install, Config Harbor
    tags: harbor
    block:
      - unarchive:
          src: https://github.com/goharbor/harbor/releases/download/{{ HARBOR_VERSION }}/harbor-offline-installer-{{ HARBOR_VERSION }}.tgz
          dest: /tmp
          remote_src: yes
      - copy:
          src: /tmp/harbor
          remote_src: true
          dest: /home/devops
      - copy:
          src: ./config/harbor/
          dest: /home/devops/harbor
  - name: Install, Config minio
    tags: minio
    block:
      - file:
          path: /home/devops/minio/data
          state: directory
      - copy:
          src: ./config/minio/minio.yaml
          dest: /home/devops/minio
      - shell: |
          cd /home/devops/minio
          docker-compose -f minio.yaml up -d

  - name: Install, Config vault
    tags: vault
    block:
      - shell: |
            wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --yes --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
      - apt:
          name:
            - vault=1.4.*
          state: present
          update_cache: yes

      - file:
          path: /home/devops/vault/data
          state: directory

      - copy:
          src: ./config/vault/
          dest: /home/devops/vault

      - name: Copy systemd init file
        copy:
          src: ./config/vault/vault.service
          dest: /etc/systemd/system
          owner: devops
          group: devops

      - name: Start vault
        systemd:
          name: vault
          state: restarted
          enabled: true
          daemon_reload: true

      - shell: vault operator init -key-shares={{ VAULT_KEY_SHARE }} -key-threshold={{ VAULT_KEY_THRES }} -format=yaml
        environment:
          VAULT_ADDR: "http://127.0.0.1:8200"
        register: token

      - local_action:
          module: copy
          content: "{{ token.stdout }}"
          dest:   ./config/vault/token

      - name: Parse output of vault init
        set_fact:
          vault_init_parsed: "{{ token.stdout | from_yaml }}"

      - name: Unseal vault
        shell: |
          vault operator unseal {{ item }}
        environment:
          VAULT_ADDR: "http://127.0.0.1:8200"
        loop: "{{ vault_init_parsed.unseal_keys_b64[:VAULT_KEY_THRES] }}"

      - debug:
          msg: "export VAULT_ADDR=http://{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}:8200"

  - name: Install, Config NFS
    tags: nfs
    block:
      - apt:
          name:
          - nfs-kernel-server
          state: present
      - file:
          path: /home/devops/nfs_share
          state: directory
          owner: nobody
          group: nogroup
          mode: '0775'
      - name: enable rpcbind nfslock nfs
        service:
          name:  nfs-kernel-server
          enabled: yes
      - name: Copy exports file.
        copy:
          src: ./config/nfs_exports
          dest: /etc/exports
      - name: NFS apply change configrue
        shell: systemctl reload nfs;exportfs -a